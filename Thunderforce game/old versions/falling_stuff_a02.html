<!-- Refactored bullets into an array of their own -->

<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>WIP Thunderforce</title>
	</head>

	<body>
    <div class="gameTitle" style="text-align: center;">
        <h2>Shmunder Shmorce</h2>
        <ul>
            <li>Move the mouse to move the player</li>
            <li>Hold space to boost speed</li>
            <li>Click to shoot</li>
        </ul>
        <p>Move up and down, avoid incoming asteroids and destory enemies to score points!</p>

        <form id="Game Controls">
            <input type="button" value="Start game" onclick="falling_stuff_namespace.start_game()">
            <input type="button" value="Stop game" onclick="falling_stuff_namespace.stop_game()">
        </form>
    </div>
    <div class="gameDock" style = "text-align:center;">
	    <canvas id="game_canvas" width="1024" height="768" style="border:20px double;"></canvas>
    </div>

    <p id = "p1">
        <!--This is an "empty" paragraph, which we can fill using JavaScript and a call to document.getElementById('p1') if we find we want to write anything on the page-->
    </p> 

<script>
    var score = 0;

    const falling_stuff_namespace = function () { // use a function to hide all the identifiers except start_game and stop_game

        /* a canvas and a canvas context to let us draw stuff */
        const canv=document.getElementById("game_canvas");
        const ctx=canv.getContext("2d");
        const canv_bounding_box = canv.getBoundingClientRect(); 
        
        /* event listener calls move when the canvas is clicked */
        canv.addEventListener("mousemove", move ,false);
        canv.addEventListener("click", fire ,false);

        // a constructor for a box class 
        function Box(x, y, width, height, colour) {
            this.x = x;
            this.y = y;
            this.width = width;
            this.height = height;
            this.colour = colour;  // default is a black box
            this.draw = function (ctx) { // a method
                ctx.save();
                    ctx.fillStyle = this.colour;
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.restore();
            }
        }

        var me = new Box(canv.width+30, canv.height-30, 25, 40, "#f00" );


        /* move calculates a new x position for the player */
        function move( e ) {
            e.preventDefault();
            me.x=(e.clientX-canv_bounding_box.left) *
                (canv.width/canv_bounding_box.width);	
        }

        /* fire adds a new falling box to the list of falling_boxes */
        /* a negative dy value makes the falling_box go up */
        function fire( e ) {
            e.preventDefault();
            theBullets.bullets.push( new Bullet( me.x, me.y-20, -3, 5, "#00f" ));
            theBullets.bullets[i].draw(ctx);
        }

        function was_i_hit( some_falling_box ) {

            if (
                (some_falling_box.left > (me.x + me.width))
                || (some_falling_box.right < me.x)
                || (some_falling_box.top > (me.y + me.height))
                || (some_falling_box.bottom < me.y)
            ) {
                // do nothing, the box missed me
            } else {
                // a kind of reducing health - you could change this to deal with good boxes
                me.height -= 0.2*some_falling_box.mass*some_falling_box.dy;
                if (me.height < 0) {
                    stop_game()
                }
            }
        }

        function did_bullet_connect( bullet ) {

            if (
                (some_falling_box.left > (bullet.x + bullet.width))
                || (some_falling_box.right < bullet.x)
                || (some_falling_box.top > (bullet.y + bullet.height))
                || (some_falling_box.bottom < bullet.y)
            ) {
                // do nothing, the box missed me
            } else {
                // a kind of reducing health - you could change this to deal with good boxes
                me.height -= 0.2*some_falling_box.mass*some_falling_box.dy;
                if (me.height < 0) {
                    stop_game()
                }
            }
        }
        
        /* constructor for creating new bullets */
        function Bullet( x, y, dy, mass, colour ) {
            this.x = x;
            this.y = y;
            this.dy = dy;
            this.mass = mass;
            this.colour = colour;

            this.height = 2*this.mass;
            this.width = 3*this.mass;
            this.top =this.y;
            this.bottom = this.y + this.height;
            this.left = this.x;
            this.right = this.x + this.width;

            this.update_position = function () {
                this.y += dy;
                this.top = this.y;
                this.bottom = this.y + this.height;
            },

            this.draw = function ( context ) {
                var save_fillStyle = context.fillStyle;
                context.fillStyle = this.colour
                context.fillRect(
                    this.x, this.y,
                    this.width, this.height );
                context.fillStyle = save_fillStyle
            },

            this.explode = function ( explosion_colour ) {
                this.height += this.mass*this.dy;
                this.width += this.mass*this.dy;
                this.colour = explosion_colour
                this.dy = 0;
            }
        }

        var theBullets = { // an object with an array of boxes and two functions to add boxes to the array

        /* an empty array to store falling_boxes */
        bullets: [],

        /* create a falling_box and add it to the array of falling_boxes */
        add_bullet: function () {

            var x = me.x + (me.width/2);
            var y = Math.random() * (canv.height/2);
            var dy = (Math.random() * 3) + 1;
            var mass = (Math.random() * 20) + 1;

            this.add_bullet.push( new Bullet( x, y, dy, mass, "#000000") )
        },
        }

        /* constructor for creating new falling boxes */
        function Falling_box( x, y, dy, mass, colour ) {
            this.x = x;
            this.y = y;
            this.dy = dy;
            this.mass = mass;
            this.colour = colour;

            this.height = 2*this.mass;
            this.width = 3*this.mass;
            this.top =this.y;
            this.bottom = this.y + this.height;
            this.left = this.x;
            this.right = this.x + this.width;

            this.update_position = function () {
                this.y += dy;
                this.top = this.y;
                this.bottom = this.y + this.height;
            },

            this.draw = function ( context ) {
                var save_fillStyle = context.fillStyle;
                context.fillStyle = this.colour
                context.fillRect(
                    this.x, this.y,
                    this.width, this.height );
                context.fillStyle = save_fillStyle
            },

            this.explode = function ( explosion_colour ) {
                this.height += this.mass*this.dy;
                this.width += this.mass*this.dy;
                this.colour = explosion_colour
                this.dy = 0;
            }
        }

        var the_falling_boxes = { // an object with an array of boxes and two functions to add boxes to the array

            /* an empty array to store falling_boxes */
            falling_boxes: [],

            /* create a falling_box and add it to the array of falling_boxes */
            add_random_falling_box: function () {

                var x = Math.random() * canv.width;
                var y = Math.random() * (canv.height/2);
                var dy = (Math.random() * 3) + 1;
                var mass = (Math.random() * 20) + 1;

                this.falling_boxes.push( new Falling_box( x, y, dy, mass, "#000000") )
            },

            maybe_add_random_falling_box: function ( how_likely ) {
                var maybe = Math.random();
                if ( maybe < how_likely) {
                    this.add_random_falling_box()
                }
            }
        }

        var game_interval;

        function start_game() {
            game_interval = setInterval(game_loop, 50)
        }

        function draw_everything() {
            /* first thing to do each frame is clear the canvas */
            ctx.clearRect(0, 0, canv.width, canv.height);

            /* and draw the player */
            me.draw(ctx);
            
            /* and draw all the falling_boxes */
            for (i=0; i<the_falling_boxes.falling_boxes.length; i++) {
                the_falling_boxes.falling_boxes[i].draw(ctx);
            }
            for (i=0; i<theBullets.bullets.length; i++) {
                theBullets.bullets[i].draw(ctx);
            }
        }

        function game_loop() {

            /* update falling_box positions and remove falling_boxes that have gone off the canvas */
            var i;
            var j;

            /* randomly add some new falling boxes */
            the_falling_boxes.maybe_add_random_falling_box( 0.03 );

            for (i=0; i<the_falling_boxes.falling_boxes.length; i++) {

                the_falling_boxes.falling_boxes[i].update_position();

                if ( (the_falling_boxes.falling_boxes[i].dy == 0)
                    || (the_falling_boxes.falling_boxes[i].y > canv.height)
                ) {
                    the_falling_boxes.falling_boxes.splice( i, 1 );
                }
            } 

            for (i=0; i<theBullets.bullets.length; i++) {

                theBullets.bullets[i].update_position();

                if ( (theBullets.bullets[i].dy == 0)
                    || (theBullets.bullets[i].y > canv.height)
                ) {
                    theBullets.bullets.splice( i, 1 );
                }
            } 

            for (i=0; i<the_falling_boxes.falling_boxes.length; i++) {

                was_i_hit( the_falling_boxes.falling_boxes[i] );

                //add code to do something interesting when a falling black box is hit by a fired blue box

            }
            
            document.getElementById("p1").innerHTML = score;
            draw_everything();

        }

        /* stop updating and re-drawing the screen */
        function stop_game() {
            clearInterval(game_interval);
        }

        return { // an object with two attributes, start_game whose value is the function (method) start_game() and stop_game whose value is stop_game()
            start_game: start_game,
            stop_game: stop_game
        }
    }() // execute the anonymous function in order to return the object with attributes start_game and stop_game, which is assigned to falling_stuff_namespace

</script>
</body>
</html>

<style>
p {
    color: white;}

body {
    background-color: black;}

h2 {
    color: white;}

ul {
    color: white;}

.gameTitle {
    background-color: black;}

.gameDock {
    background-color: grey;
    margin: 10px 10px 10px 10px;}

</style>
